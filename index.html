<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BEV Trajectories • Gallery</title>
<style>
:root{--maxw:1200px;--gap:14px}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:#0b0c10;color:#e9eef2}
header{position:sticky;top:0;z-index:5;background:#0f1117cc;backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid #1c2333}
.bar{max-width:var(--maxw);margin:0 auto;padding:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.bar h1{grid-column:1/-1;margin:4px 0 8px;font-size:20px;font-weight:600}

select,input,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #273145;background:#0f1525;color:#e9eef2}
select{appearance:none;-webkit-appearance:none;-moz-appearance:none;
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23e9eef2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
  background-repeat:no-repeat;background-position:right 12px center;background-size:12px 12px;padding-right:36px}
select::-ms-expand{display:none}

.controls{display:contents}
.chips{display:flex;gap:10px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #2a3654;background:#0b1324;border-radius:999px;font-size:14px;font-weight:600;color:#eef3ff}
.chip input[type="checkbox"]{accent-color:#4da3ff;inline-size:1.15rem;block-size:1.15rem;margin:0}
.wrap{max-width:var(--maxw);margin:16px auto;padding:10px}

.grid{display:grid;gap:var(--gap);grid-template-columns:repeat(auto-fill, minmax(420px, 1fr))}
@media (min-width:1600px){ .grid{ grid-template-columns:repeat(auto-fill, minmax(500px, 1fr)) } }

.card{background:#0f1525;border:1px solid #1f2a44;border-radius:14px;overflow:hidden;display:flex;flex-direction:column;transition:box-shadow .15s ease}
.card:hover{ box-shadow:0 10px 24px rgba(0,0,0,.35) }
.thumbbox{aspect-ratio:16/9;width:100%;background:#121826;display:flex;align-items:center;justify-content:center;overflow:hidden;border-bottom:1px solid #1f2a44}
.thumb{max-width:100%;max-height:100%;object-fit:contain;display:block;transition:transform .15s ease}
.thumbbox:hover .thumb{transform:scale(1.06)}

.meta{padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.meta .left{display:flex;flex-direction:column}
.country{font-weight:700}
.type,.date{opacity:1;font-size:12px}
.footer{padding:8px 12px;border-top:1px solid #1f2a44;display:flex;align-items:center;gap:10px}
.btn{cursor:pointer;border:1px solid #2a385d;background:#101a33;padding:8px 10px;border-radius:10px;text-decoration:none;color:#e9eef2}
.filename{min-width:0;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;opacity:.95;font-size:12px;border:1px solid #2b364f;border-radius:8px;padding:4px 8px;background:#0f1525}
.empty{opacity:.7;text-align:center;padding:40px}
.badge{padding:2px 8px;border:1px solid #2b364f;border-radius:999px;background:#0f1525;font-size:12px}
@media (max-width:720px){.bar{grid-template-columns:1fr 1fr}.chips{grid-column:1/-1}}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>BEV Trajectories • Gallery</h1>

      <div class="controls">
        <select id="countrySelect"><option value="">All countries</option></select>
      </div>

      <div class="controls">
        <div class="chips">
          <label class="chip"><input type="checkbox" value="ICE_BEV" checked/> ICE↔BEV trajectory</label>
          <label class="chip"><input type="checkbox" value="time" checked/> Transition time curves</label>
          <label class="chip"><input type="checkbox" value="ttm_shares" checked/> TTM market split</label>
          <label class="chip"><input type="checkbox" value="share" checked/> BEV trajectory</label>
          <label class="chip"><input type="checkbox" id="latestOnly" checked/> Latest only</label>
        </div>
      </div>

      <div class="controls">
        <div style="display:flex;gap:10px">
          <select id="periodSelect" hidden><option value="">All months</option></select>
          <input id="search" placeholder="Search (country, type, filename)" />
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="stats" style="margin-bottom:10px;opacity:.8"></div>
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" hidden>No matches. Relax filters.</div>
  </main>

/* Lightbox: immer auf Bildschirm einpassen */
dialog#lightbox{
  border: none;
  padding: 0;
  background: rgba(0,0,0,.6);
}
dialog#lightbox::backdrop{
  background: rgba(0,0,0,.6);
}
.lb{
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100vw;
  height: 100vh;
  max-width: 100vw;
  max-height: 100vh;
  margin: 0;
}
.lb img{
  width: auto;                /* nicht hart strecken */
  height: auto;
  max-width: min(96vw, 1600px);
  max-height: 92vh;           /* Platz für Close-Button */
  object-fit: contain;        /* komplett sichtbar */
  display: block;
  border-radius: 10px;
  background: #0b0c10;
}
.btn.x{
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 2;
}

<script>
const grid = document.getElementById('grid');
const empty = document.getElementById('empty');
const lb = document.getElementById('lightbox');
const lbImg = lb.querySelector('img');
const countrySelect = document.getElementById('countrySelect');
const periodSelect  = document.getElementById('periodSelect');
const searchInput   = document.getElementById('search');
const stats = document.getElementById('stats');
const typeChecks = [...document.querySelectorAll('.chip input[type="checkbox"][value]')];
const latestOnly   = document.getElementById('latestOnly');

const TYPE_LABEL = {
  ICE_BEV: 'ICE↔BEV trajectory',
  time: 'Transition time curve',
  ttm_shares: 'TTM market split graph',
  share: 'BEV trajectory'
};

function prettyPeriod(p){
  if(!/^\d{4}-\d{2}$/.test(p)) return p;
  const [y,m] = p.split('-').map(Number);
  return new Date(y, m-1, 1).toLocaleDateString('en-US', {month:'short', year:'numeric'});
}

async function loadManifest(){
  const res = await fetch('manifest.json', {cache:'no-store'});
  return res.json();
}
const uniq = xs => [...new Set(xs)];

function latestByKey(items){
  const map = new Map();
  const toNum = p => Number((p||"0000-00").replace("-",""));
  for(const it of items){
    const k = `${it.country}|||${it.type}`;
    const cur = map.get(k);
    if(!cur || toNum(it.period) > toNum(cur.period)) map.set(k, it);
  }
  return [...map.values()];
}

function render(items){
  grid.innerHTML = '';
  if(items.length === 0){ empty.hidden = false; stats.textContent = ''; return; }
  empty.hidden = true;
  stats.innerHTML = `<span class="badge">${items.length} charts</span>`;
  const frag = document.createDocumentFragment();
  for(const it of items){
    const card = document.createElement('article');
    card.className = 'card';

    const box = document.createElement('div');
    box.className = 'thumbbox';
    const img = document.createElement('img');
    img.className = 'thumb';
    img.loading='lazy'; img.decoding='async';
    img.src = it.url; img.alt = it.alt || `${it.country} – ${it.type}`;
    img.addEventListener('click', ()=>{ lbImg.src = it.url; lbImg.alt = img.alt; lb.showModal(); });
    box.append(img);

    const meta = document.createElement('div');
    meta.className = 'meta';
    const right = [it.period || '', it.date || ''].filter(Boolean).join(' • ');
    meta.innerHTML = `<div class="left"><div class="country">${it.country}</div><div class="type">${TYPE_LABEL[it.type] || it.type}</div></div><div class="date">${right}</div>`;

    const footer = document.createElement('div');
    footer.className = 'footer';
    footer.innerHTML = `<a class="btn" href="${it.url}" download>Download</a><span class="filename">${it.filename}</span>`;

    card.append(box, meta, footer);
    frag.append(card);
  }
  grid.append(frag);
}

function applyFilters(all){
  const q = searchInput.value.trim().toLowerCase();
  const allowedTypes = new Set(typeChecks.filter(c=>c.checked).map(c=>c.value));
  const country = countrySelect.value;
  const period  = periodSelect.value;

  let out = all.filter(it=>{
    if(country && it.country !== country) return false;
    if(!allowedTypes.has(it.type)) return false;
    if(period && it.period !== period) return false;
    const hay = `${it.country} ${it.type} ${it.date} ${it.period} ${it.filename}`.toLowerCase();
    return q === '' || hay.includes(q);
  });

  if(latestOnly && latestOnly.checked && !period) out = latestByKey(out);
  return out;
}

loadManifest().then(({images})=>{
  const countries = uniq(images.map(x=>x.country)).sort();
  countries.forEach(c=>{
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; countrySelect.append(opt);
  });
  const periods = uniq(images.map(x=>x.period).filter(Boolean)).sort();
  if(periods.length){
    periodSelect.hidden = false;
    periods.forEach(p=>{ const o = document.createElement('option'); o.value = p; o.textContent = prettyPeriod(p); periodSelect.append(o); });
  }

  const update = ()=>render(applyFilters(images));
  countrySelect.addEventListener('change', update);
  periodSelect.addEventListener('change', update);
  typeChecks.forEach(c=>c.addEventListener('change', update));
  latestOnly.addEventListener('change', update);
  searchInput.addEventListener('input', update);
  update();
});
</script>
</body>
</html>
